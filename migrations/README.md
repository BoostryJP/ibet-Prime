# For developers

## Initial setup

By executing the following command, migration will be performed to the current version.

```bash
$ ./bin/run_migration.sh init
```

## Generate migration script

Once you have changed the DB model, create a migration script.

### Prerequisites
* Complete the initial setup.
* Do not set the environment variable: `DATABASE_SCHEMA`.

### Auto-Generate script

The following steps will automatically generate a migration script.

```bash
$ ./bin/run_migration.sh generate $file_suffix
```
e.g.) ./bin/run_migration.sh generate v1.0.0

### Upgrade

```bash
$ ./bin/run_migration.sh upgrade
```

### Downgrade

To revert to the initial state, execute the following command.

```bash
$ ./bin/run_migration.sh downgrade
```

To revert to the previous version, use `-1`.

```bash
$ ./bin/run_migration.sh downgrade -1
```

## Notice
In the following cases, you will need to manually modify the autogenerated script.

### If column name changed.

* CREATE/DROP script will be generated automatically.
* By executing the auto-generated script, the data in the existing columns will be deleted.

e.g.)  
*Before(Auto-generated)*
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('account', sa.Column('keyfile_json', sa.JSON(), nullable=True), schema=get_db_schema())
    op.drop_column('account', 'keyfile', schema=get_db_schema())
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('account', sa.Column('keyfile', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True), schema=get_db_schema())
    op.drop_column('account', 'keyfile_json', schema=get_db_schema())
    # ### end Alembic commands ###
```

*After(Manually modify)*
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'keyfile', new_column_name='keyfile_json', existing_type=sa.JSON(), schema=get_db_schema())
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'keyfile_json', new_column_name='keyfile', existing_type=sa.JSON(), schema=get_db_schema())
    # ### end Alembic commands ###
```

### If column constraint changed.

* The execution of the auto-generated scripts may fail.
* For example, constrains changed Nullable to NotNull, etc

e.g.)  
*Before(Auto-generated)*
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'eoa_password',
               existing_type=sa.VARCHAR(length=2000),
               nullable=False, schema=get_db_schema())
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'eoa_password',
               existing_type=sa.VARCHAR(length=2000),
               nullable=True, schema=get_db_schema())
    # ### end Alembic commands ###
```

*After(Manually modify)*
```python
from sqlalchemy.orm.session import Session
from app.model.db import Account  # Target Table Model

def upgrade():
    session = Session(bind=op.get_bind())
    _accounts = session.query(Account).filter(Account.eoa_password == None).all()
    for _account in _accounts:
        _account.eoa_password = "DEFAULT_WORD"
    session.flush()
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'eoa_password',
               existing_type=sa.VARCHAR(length=2000),
               nullable=False, schema=get_db_schema())
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('account', 'eoa_password',
               existing_type=sa.VARCHAR(length=2000),
               nullable=True, schema=get_db_schema())
    session = Session(bind=op.get_bind())
    _accounts = session.query(Account).filter(Account.eoa_password == "DEFAULT_WORD").all()
    for _account in _accounts:
        _account.eoa_password = None
    session.flush()
    # ### end Alembic commands ###
```
